<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Firebase Notifications</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
</head>

<body>

<h2>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ðŸ””</h2>
<button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyDPcyxpHRuLx9T2CO4LJ-n9jaqAynUjvqw",
 authDomain:"xix5-a119a.firebaseapp.com",
 projectId:"xix5-a119a",
 messagingSenderId:"332265425367",
 appId:"1:332265425367:web:0a95e71d8bd0058503a392"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

/* ØªØ³Ø¬ÙŠÙ„ Service Worker */
async function registerSW(){
 return await navigator.serviceWorker.register("firebase-messaging-sw.js");
}

/* Ø·Ù„Ø¨ Ø¥Ø°Ù† */
async function requestNotificationPermission(uid){
 try{
  const permission = await Notification.requestPermission();
  if(permission !== "granted") return;

  const registration = await registerSW();

  const token = await messaging.getToken({
   vapidKey:"BEIkmsbcatAy4Kq8_ehZE19KzKQx2pHaYvIKmgTEq1oFSmePLEG7faBAsibGl1mFCNDbFv9-znm2x4DzpDISS8o",
   serviceWorkerRegistration: registration
  });

  console.log("TOKEN:", token);

  await db.collection("tokens").doc(uid).set({
   token:token,
   createdAt:new Date()
  });

 }catch(err){
  console.error(err);
 }
}

/* ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
function login(){
 auth.signInAnonymously();
}

/* Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
auth.onAuthStateChanged(user=>{
 if(user){
  requestNotificationPermission(user.uid);
 }
});

/* Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØªÙˆØ­ */
messaging.onMessage(payload=>{
 new Notification(payload.notification.title,{
  body:payload.notification.body,
  icon:"https://cdn-icons-png.flaticon.com/512/1827/1827392.png"
 });
});
</script>

</body>
</html>
